<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Servi√ßos Ativos - PetMarket</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="style.css">
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    margin: 0; 
    padding: 0; 
}

/* Header Section */
.servicos-header {
    background: rgba(255, 255, 255, 0.95);
    padding: 30px 40px;
    margin-bottom: 40px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.servicos-header-content {
    max-width: 1300px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
}

.servicos-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: flex;
    align-items: center;
    gap: 12px;
}

.servicos-header h1 i {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.btn-voltar {
    padding: 12px 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.btn-voltar:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}

.container { 
    max-width: 1200px; 
    margin: 0 auto 60px; 
    padding: 40px 20px; 
}

.servicos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 30px;
}

.servico-card { 
    background: white;
    border: 2px solid transparent;
    border-radius: 20px; 
    padding: 25px; 
    box-shadow: 0 5px 25px rgba(0,0,0,0.1); 
    position: relative;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.servico-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 40px rgba(102, 126, 234, 0.2);
    border-color: rgba(102, 126, 234, 0.3);
}

.servico-card h3 { 
    margin: 0 0 15px 0;
    font-size: 1.5rem;
    color: #333;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

.servico-card h3 i {
    color: #667eea;
    font-size: 1.3rem;
}

.servico-card p { 
    margin: 10px 0;
    color: #666;
    font-size: 0.95rem;
    line-height: 1.6;
}

.servico-card p strong {
    color: #333;
    font-weight: 600;
}

.servico-card .preco {
    font-size: 1.8rem;
    font-weight: 700;
    background: linear-gradient(135deg, #20bf6b 0%, #17a65c 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: block;
    margin: 15px 0;
}

.btn-agendar { 
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 15px; 
    padding: 12px 24px; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; 
    text-decoration: none; 
    border-radius: 25px; 
    cursor: pointer;
    border: none;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.btn-agendar:hover { 
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}

.msg { 
    background: white;
    color: #e74c3c;
    text-align: center; 
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 15px;
    font-weight: 500;
    box-shadow: 0 5px 25px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.msg.success {
    color: #20bf6b;
    background: #f0fdf4;
}

.msg.empty {
    color: #666;
    background: white;
    padding: 60px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.msg.empty i {
    font-size: 4rem;
    color: #ccc;
}

.agendamento-info {
    margin-top: 15px;
    padding: 15px;
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border: 2px solid #4caf50;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #2e7d32;
    font-weight: 600;
}

.agendamento-info i {
    font-size: 1.2rem;
    color: #4caf50;
}

.form-agendamento {
    margin-top: 20px;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px solid rgba(102, 126, 234, 0.2);
    border-radius: 15px;
    display: none;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.form-agendamento label {
    display: block;
    margin-top: 15px;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
    font-size: 0.95rem;
}

.form-agendamento input,
.form-agendamento select {
    width: 100%;
    padding: 12px 15px;
    margin-top: 5px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
}

.form-agendamento input:focus,
.form-agendamento select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn-confirmar {
    margin-top: 20px;
    width: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 14px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.btn-confirmar:hover { 
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}

@media (max-width: 768px) {
    .servicos-header {
        padding: 20px;
    }
    
    .servicos-header h1 {
        font-size: 1.8rem;
    }
    
    .servicos-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .container {
        padding: 20px;
    }
}
</style>
</head>
<body>

<!-- Navbar -->
<header class="navbar">
    <div class="logo">
        <i class="fas fa-paw"></i> PetMarket
    </div>
    <nav>
        <a href="index.html"><i class="fas fa-home"></i> Home</a>
        <a href="produtos.html"><i class="fas fa-box"></i> Produtos</a>
        <a href="servico.html"><i class="fas fa-concierge-bell"></i> Servi√ßos</a>
        <a href="carrinho.html" id="cart" class="carrinho">
            <i class="fas fa-shopping-cart"></i>
            <span id="cartCount" class="numero-carrinho">0</span>
        </a>
        <button id="logoutBtn" class="btn-login">
            <i class="fas fa-sign-out-alt"></i> Sair
        </button>
        <a href="login_cliente.html" class="btn-login" id="btnLogin">
            <i class="fas fa-sign-in-alt"></i> Entrar
        </a>
    </nav>
</header>

<!-- Header Section -->
<section class="servicos-header">
    <div class="servicos-header-content">
        <h1><i class="fas fa-concierge-bell"></i> Servi√ßos Ativos</h1>
        <a href="index.html" class="btn-voltar">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>
</section>

<div class="container">
  <div id="msg" class="msg" style="display: none;"></div>
  <div id="listaServicos" class="servicos-grid"></div>
</div>

<footer class="footer">
    <div class="footer-container">
        <div class="footer-logo">
            <div class="logo">üêæ PetMarket</div>
        </div>
        <div class="footer-info">
            <p>¬© Copyright 2025 ‚Äì PetMarket ‚Äì Todos os direitos reservados PetMarket Servi√ßos Digitais S.A.</p>
            <p>CNPJ 12.345.678/0001-90 / Rua Ceara, n¬∫ 1200, Bairro Centro, Imperatriz/MA ‚Äì CEP 01.234-567</p>
        </div>
        <div class="footer-links">
            <a href="#">Termos e condi√ß√µes de uso</a>
            <a href="#">C√≥digo de conduta</a>
            <a href="#">Privacidade</a>
            <a href="#">Dicas de seguran√ßa</a>
        </div>
    </div>
</footer>

<script>
// Criar op√ß√µes de hor√°rios 08:00 √†s 18:00
function gerarHorarios() {
    const horarios = [];
    for (let h = 8; h <= 18; h++) {
        let hora = h.toString().padStart(2, "0") + ":00";
        horarios.push(hora);
    }
    return horarios;
}

async function carregarServicos() {
    const container = document.getElementById("listaServicos");
    const msg = document.getElementById("msg");
    container.innerHTML = "";
    msg.style.display = "none";
    msg.className = "msg";

    try {
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; background: white; border-radius: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.1);">
                <i class="fas fa-spinner" style="font-size: 3rem; color: #667eea; animation: spin 1s linear infinite;"></i>
                <p style="margin-top: 20px; color: #667eea; font-size: 1.2rem;">Carregando servi√ßos...</p>
            </div>
        `;

        const res = await fetch("http://localhost:3000/servico");

        if (!res.ok) {
            const err = await res.json();
            container.innerHTML = "";
            msg.className = "msg";
            msg.style.display = "flex";
            msg.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${err.error || "Erro ao carregar servi√ßos."}`;
            return;
        }

        const servicos = await res.json();
        
        // Buscar agendamentos do cliente se estiver logado
        let agendamentos = [];
        const token = localStorage.getItem("token_cliente");
        if (token) {
            try {
                const resAgendamentos = await fetch("http://localhost:3000/agendamento", {
                    headers: { "Authorization": "Bearer " + token }
                });
                if (resAgendamentos.ok) {
                    agendamentos = await resAgendamentos.json();
                }
            } catch (e) {
                console.error("Erro ao buscar agendamentos:", e);
            }
        }

        if (servicos.length === 0) {
            container.innerHTML = `
                <div class="msg empty" style="grid-column: 1/-1; display: flex;">
                    <i class="fas fa-concierge-bell"></i>
                    <p>Nenhum servi√ßo ativo encontrado.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = "";

        servicos.forEach(s => {
            const card = document.createElement("div");
            card.className = "servico-card";
            card.id = `card-${s.id_servico}`;

            // Verificar se h√° agendamento para este servi√ßo
            const agendamento = agendamentos.find(a => a.id_servico === s.id_servico);
            const temAgendamento = agendamento && agendamento.data_hora;
            
            // Formatar data e hora se houver agendamento
            let infoAgendamento = "";
            if (temAgendamento) {
                const dataHora = new Date(agendamento.data_hora);
                const dataFormatada = dataHora.toLocaleDateString('pt-BR', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric' 
                });
                const horaFormatada = dataHora.toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                infoAgendamento = `
                    <div class="agendamento-info">
                        <i class="fas fa-calendar-check"></i>
                        <span>Agendado para: ${dataFormatada} √†s ${horaFormatada}</span>
                    </div>
                `;
            }

            // Criar hor√°rios
            const horarios = gerarHorarios();
            let opcoesHorarios = "";
            horarios.forEach(h => opcoesHorarios += `<option value="${h}">${h}</option>`);

            card.innerHTML = `
                <h3><i class="fas fa-spa"></i> ${s.nome}</h3>
                <p><strong><i class="fas fa-store"></i> Petshop:</strong> ${s.nome_petshop}</p>
                <p><strong><i class="fas fa-info-circle"></i> Descri√ß√£o:</strong> ${s.descricao || 'Sem descri√ß√£o'}</p>
                <span class="preco">R$ ${parseFloat(s.preco).toFixed(2).replace('.', ',')}</span>
                <p><strong><i class="fas fa-clock"></i> Dura√ß√£o:</strong> ${s.duracao_minutos} minutos</p>

                ${infoAgendamento}

                ${!temAgendamento ? `
                    <button class="btn-agendar" onclick="abrirFormulario(${s.id_servico})">
                        <i class="fas fa-calendar-plus"></i> Agendar
                    </button>

                    <div id="form-${s.id_servico}" class="form-agendamento">
                        <label><i class="fas fa-calendar"></i> Data:</label>
                        <input type="date" id="data-${s.id_servico}" min="${new Date().toISOString().split("T")[0]}" required>

                        <label><i class="fas fa-clock"></i> Hor√°rio:</label>
                        <select id="horario-${s.id_servico}" required>
                            <option value="">Selecione um hor√°rio</option>
                            ${opcoesHorarios}
                        </select>

                        <button class="btn-confirmar" onclick="confirmar(${s.id_servico})">
                            <i class="fas fa-check"></i> Confirmar Agendamento
                        </button>
                    </div>
                ` : ''}
            `;

            container.appendChild(card);
        });

    } catch (e) {
        console.error("Erro ao carregar servi√ßos:", e);
        container.innerHTML = "";
        msg.className = "msg";
        msg.style.display = "flex";
        msg.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Erro ao carregar servi√ßos. Verifique se o backend est√° rodando.`;
    }
}

// Abre o formul√°rio de agendamento
function abrirFormulario(id) {
    document.querySelectorAll(".form-agendamento").forEach(f => f.style.display = "none");
    document.getElementById("form-" + id).style.display = "block";
}

async function confirmar(id_servico) {
    const data = document.getElementById("data-" + id_servico).value;
    const hora = document.getElementById("horario-" + id_servico).value;
    const msg = document.getElementById("msg");

    if (!data || !hora) {
        msg.className = "msg";
        msg.style.display = "flex";
        msg.innerHTML = `<i class="fas fa-exclamation-circle"></i> Preencha data e hor√°rio!`;
        msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }

    const token = localStorage.getItem("token_cliente");

    if (!token) {
        alert("Voc√™ precisa estar logado para agendar.");
        window.location.href = "login_cliente.html";
        return;
    }

    try {
        const btnConfirmar = document.querySelector(`#form-${id_servico} .btn-confirmar`);
        const originalText = btnConfirmar.innerHTML;
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Agendando...';

        const res = await fetch("http://localhost:3000/agendamento", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({ 
                id_servico,
                data,
                hora
            })
        });

        const json = await res.json();

        if (!res.ok) {
            msg.className = "msg";
            msg.style.display = "flex";
            msg.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${json.error || "Erro ao agendar."}`;
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = originalText;
            msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        msg.className = "msg success";
        msg.style.display = "flex";
        msg.innerHTML = `<i class="fas fa-check-circle"></i> Agendamento realizado com sucesso!`;
        
        // Atualizar o card para mostrar a data e hora agendada
        const card = document.getElementById(`card-${id_servico}`);
        if (card) {
            const dataFormatada = new Date(data).toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
            
            // Remover bot√£o e formul√°rio
            const btnAgendar = card.querySelector('.btn-agendar');
            const formAgendamento = card.querySelector('.form-agendamento');
            if (btnAgendar) btnAgendar.remove();
            if (formAgendamento) formAgendamento.remove();
            
            // Adicionar informa√ß√£o de agendamento
            const infoAgendamento = document.createElement('div');
            infoAgendamento.className = 'agendamento-info';
            infoAgendamento.innerHTML = `
                <i class="fas fa-calendar-check"></i>
                <span>Agendado para: ${dataFormatada} √†s ${hora}</span>
            `;
            
            // Inserir antes do √∫ltimo elemento (ou no final do card)
            const duracao = card.querySelector('p:last-of-type');
            if (duracao) {
                duracao.insertAdjacentElement('afterend', infoAgendamento);
            } else {
                card.appendChild(infoAgendamento);
            }
        }
        
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = originalText;
        msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        setTimeout(() => {
            msg.style.display = "none";
        }, 3000);
    } catch (e) {
        console.error(e);
        msg.className = "msg";
        msg.style.display = "flex";
        msg.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Erro ao conectar com servidor.`;
        msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}




// =========================
// üîπ CONTROLE DE LOGIN / LOGOUT
// =========================
const nomeCliente = localStorage.getItem("cliente_nome");
const btnLogin = document.getElementById("btnLogin");
const logoutBtn = document.getElementById("logoutBtn");

if (nomeCliente) {
    btnLogin.style.display = "none";
    if (logoutBtn) logoutBtn.style.display = "inline-block";
} else {
    if (logoutBtn) logoutBtn.style.display = "none"; 
    btnLogin.style.display = "inline-block";
}

if (logoutBtn) {
    logoutBtn.addEventListener("click", () => {
        localStorage.clear();
        window.location.reload();
    });
}

// =========================
// üîπ CARRINHO
// =========================
async function atualizarCarrinho() {
    const token = localStorage.getItem("token_cliente");
    if (!token) {
        const cartCount = document.getElementById("cartCount");
        if (cartCount) cartCount.textContent = 0;
        return;
    }

    try {
        const res = await fetch("http://localhost:3000/carrinho", {
            headers: {
                "Authorization": "Bearer " + token
            }
        });
        const data = await res.json();

        const cartCount = document.getElementById("cartCount");
        if (cartCount) {
            if (res.ok) {
                cartCount.textContent = data.quantidade_itens;
            } else {
                cartCount.textContent = 0;
            }
        }
    } catch (err) {
        console.error("Erro ao atualizar carrinho:", err);
        const cartCount = document.getElementById("cartCount");
        if (cartCount) cartCount.textContent = 0;
    }
}

document.addEventListener("DOMContentLoaded", () => {
    atualizarCarrinho();
    carregarServicos();
});
</script>

</body>
</html>

